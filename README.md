## Оглавление

- [Описание проекта](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#описание-проекта)

- [Инструкция к работе с C#](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#инструкция-к-работе-с-c)

- [Инструкция к работе с 1С](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#Инструкция-к-работе-с-1С)

- [Инструкция к работе с Apache Kafka](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#инструкция-к-работе-с-apache-kafka)
  - [Установки](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#для-установки-нужно)
  - [Запуск](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#запуск-kafka-и-zookeeper)
  - [Команды для работы с Apache Kafka](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#необходимые-команды-для-работы-с-apache-kafka)
  - [Полезные ссылки для Apache Kafka](https://github.com/Alekseim1500/WebServiceFor1c/blob/main/README.md#источники-для-работы-с-apache-kafka)


# Описание проекта
Данный репозиторий содержит web-сервис написанный на с# для взаимодействия между информационными базами 1с.





# Инструкция к работе с C#
#### Как запустить
Что бы запустить приложение, нужно установить visual studio и обновить пакеты NuDet при необходимости. После этого можно будет редактировать код и запускать его через visual studio. 
Что бы сделать из приложения сайт, нужно опубликовать проект. Для этого нужно выполнить следующие шаги:  
•	В обозревателе решений ПКМ по самому проекту в visual studio -> Опубликовать  
•	В появившейся вкладке нажимаем Создать  
•	Далее на каждой вкладке выбираем следующее: Веб-сервер (IIS) -> Веб-развёртывание -> Заполняем необходимые поля (Сервер: localhost, Имя сайта: Site, URL-адрес назначения: http://localhost:51992/) и нажимаем готов  
•	Заходим в IIS, ПКМ по сайты -> добавить веб-сайт -> заполняем поля (IP адрес это ip на котором разворачивается сайт)
•	Перезапускаем visual studio от имени администратора и нажимаем Опубликовать  

#### Код
Программа начинает работу в файле Global.asax.cs. В методе Application_Star в отдельные потоки запускаются функции: Methods1C8.ResponseAsync получает сообщения от 1с и отправляет их в kafka, Methods1C8.PostObject получает сообщение из kafka и отправляет в 1с.  
Вся информация, которая определяет такие параметры как кто является продюсером, на каком ip расположенна kafka и тому подобное, расположенны в файле My.config.



# Инструкция к работе с 1С
### 1С – что это такое?
1С:Предприятие — программный продукт компании «1С», предназначенный для автоматизации деятельности на предприятии.
«1С:Предприятие» предназначено для автоматизации любого бизнес-процесса предприятия. Наиболее известны продукты по автоматизации бухгалтерского и управленческого учётов (включая начисление зарплаты и управление кадрами), экономической и организационной деятельности предприятия.

### Учебная версия 1С
Так как программа «1С:Предприятие» позиционирует себя как платное приложение, для знакомства и изучения этой программы использовалась учебная версия «1С:Предприятие 8.3, учебная версия (8.3.22.1709)» (Windows). Для установки данной версии необходимо зайти на официальный сайт https://online.1c.ru/catalog/free/learning.php. На данном сайте представлены различные версии приложения «1С:Предприятие». Необходимо в верхнем меню выбрать вкладку 1С после выбрать 1С:Предприятие 8. Учебные версии, на открывшейся странице выбрать подходящую учебную версию. В моем случае это «1С:Предприятие 8.3, учебная версия (8.3.22.1709)» (Windows). После того, как зашли на страницу выбранной версии, нажать на ссылку "Получить продукт бесплатно", на открывшейся странице ввести запрашиваемые данные (ФИО, электронная почта). После чего на электронную почту придет ссылка для скачивания архива.

### Установка учебной версии 1С 
После скачивания файла распаковываем полученный архив, в нем заходим в папку platform. В самом низу папки будет находится файл с расширение .exe для установки приложения. Запускаем установку файла. После установки мы получаем приложение готовое для работы, однако это пустое приложение, то есть именно в нем нет никаких либо конфигураций и всё логику работы мы прописываем самостоятельно. Чтобы избежать лишней работы у программы «1С:Предприятие» есть готовые конфигурации для разных задач. В нашем случае использовалась для ознакомления с готовыми решениями в учебной версии рассматривалась конфигурация бухгалтерия.предприятие. В скаченном архиве данная конфигурация находится в папке accounting. В этой папке также находим установщик и запускаем его. После при создании новой базы у нас будет выбор либо создать пустую базу, либо базу с использованием конфигурации.

### Ознакомление и изучение работы с «1С:Предприятие 8.3, учебная версия (8.3.22.1709)» (Windows) 
Для пошагового изучения «1С:Предприятие»  в большой степени использовался следующий видеокурс на youtube https://www.youtube.com/watch?v=gXYUsQcT7JI&list=PL6Nx1KDcurkBdxssD1k56SDnwuTuX2bBr на данном курсе пошагово объяснялись азы использования программы. а также уроки по написанию кода на языке программирования приложения 1с, написание запросов, а также создание документов. справочников, табличных и печатных форм и работы с ними

### WEB и HTTP сервисы в 1С
Значительным отличием данной версии приложения от 1с 7.7 и от 1с8.2 это наличие WEB и HTTP сервисов соответственно (В версии 1с 7.7 отсутствуют WEB и HTTP сервисы, а в версии 1с8.2 отсутствуют HTTP сервисы. Именно по этим причинам, для работы была выбрана 1с8.3 версия платформы). WEB и HTTP сервисы — две технологии, позволяющие получить доступ к 1С из внешней системы. Причем можно получить доступ как за файрволом, так и через прокси. В общем, практически из любой точки земного шара. С точки зрения 1С, это два объекта метаданных, которые позволяют нам выполнять эти операции. Реализовывается доступ по классической трехзвенной схеме: это СУБД, в качестве сервера выступают кластер серверов 1С и веб-серверы, и клиент, подключающийся к сервису. Изначально сервисы разрабатывались для поддержки внешних систем: сайтов, интернет-магазинов, корпоративных порталов. В дальнейшем технология получила широкое распространение и сейчас используется в широком спектре схожих задач:
•	Обмен с внешними системами (сайты, магазины, мобильные приложения),
•	Обмен данными между базами 1С (гетерогенные, РИБ),
•	Работа с внешним оборудованием (телефония, ТСД, весы),
•	Предоставление упрощенного интерфейса для пользователей,
•	Предоставление API для сторонних систем или партнеров.
Для более подробного ознакомления с этими двумя сервисами можно перейти в следующий интернет ресурс https://infostart.ru/1c/articles/1523650/. Для начального разбора сервисов и попыток создание элементарного общения 1с с сервером использовались следующие интернет ресурсы https://webhamster.ru/mytetrashare/index/mtb207/1473340804tg2mplwm2d и видеоурок на youtube https://www.youtube.com/watch?v=4xju7pRcOdg&t=2579s.

### Проблема учебной версии
Как понятно из названия, используемая нами версия «1С:Предприятие» имеет ряд ограничений в работе. Одним из этих ограничений была невозможность использовать получившуюся базу в многопользовательском режиме. Для решения этой проблемы была установлена ломанная версия 8.3.18.1289.В данной папке находится файл 1cEntRepack.exe, который является установщиком ломанной версии. Для установки необходимо запустить этот файл. После нажатия на этот файл появиться следующее окно.![image](https://user-images.githubusercontent.com/94063652/225540164-696f5d97-9230-47e9-bc63-6455e35752e9.png)Для продолжения загрузки нажимаем на кнопку «Ок». Далее выполняем установку приложения. При использовании данной версии «1С:Предприятие»  проблемы многопользовательского запуска и использования приложения теперь не будет.

### Подготовка «1С:Предприятие» к публикации на Web-сервере
Для того, чтобы была возможность подключаться к информационной базе 1С с внешних источников, а не устанавливать одну и ту же базу на различных компьютерах, информационная база 1С публикуется на Web-сервере. Для того чтобы это сделать у 1С должно быть расширение для «Модули расширения веб-сервера». Данный модуль подключается на этапе установке 1С.Если при установке платформы данный модуль не был установлен, это легко исправить. Для этого заходим в панель управления.Выбираем «Программы и компоненты».Выбираем версию «1С:Предприятие», для которой необходимо изменить установку, нажимаем на правую кнопку мыши и в выпавшем меню выбираем изменить. Перед нами откроется установщик приложения, где выбираем пункт «Изменить установку», далее при установке выбираем нужный нам модуль и завершаем установку. Теперь базу 1С можно выгрузить на веб-сервер.

### Установка Web-сервера 
Для выгрузки базы на Web-сервер, на используемом компьютере должен быть установлен этот сервер. Чтобы 1С могла его увидеть. Одни из самых популярных Web-серверов это Internet Information Services и Apache. IIS (Internet Information Services) является проприетарный набор серверов для нескольких служб Интернета от компании Microsoft. Основным компонентом IIS является веб-сервер, который позволяет размещать в Интернете сайты. IIS поддерживает протоколы HTTP, HTTPS, FTP, POP3, SMTP, NNTP. В свою очередь Apache (a patchy server) является свободным (пользователи имеют права («свободы») на его неограниченную установку, запуск, свободное использование, изучение, распространение и изменение) web – сервером. Apache является кроссплатформенным ПО, поддерживает операционные системы Linux, BSD, macOS, Microsoft Windows, Novell NetWare, BeOS..Основными достоинствами Apache считаются надёжность и гибкость конфигурации. Он позволяет подключать внешние модули для предоставления данных, использовать СУБД для аутентификации пользователей, модифицировать сообщения об ошибках и т. д. Для работы с 1С был выбран Web – сервер Apache. Чтобы установить сервер Apache заходим на сайт https://www.apachelounge.com/download/ или https://httpd.apache.org/download.cgi#apache24  выбираем версию Apache. В нашем случае была выбрана версия 2.4, скачиваем архив и распаковываем его. Заходим в папку conf. Где необходимо внести изменения в файл httpd.conf ![image](https://user-images.githubusercontent.com/94063652/225540476-628b5b61-ba39-4f5d-b648-2072eff28830.png)
![image](https://user-images.githubusercontent.com/94063652/225540503-9b263a82-56aa-4a45-add9-e8fd7066d9eb.png)
Необходима правильно прописать путь к папке с сервером, иначе будет невозможно запустить Apache сервер. Далее необходима установить и запустить Apache сервер. Установка данного сервера происходит через командную строку (клавиши Win+R, ввести cmd и нажать клавишу Enter), заходим в папку bin и прописываем команду httpd.exe -k install (эта команда запускает установку сервера), после того, как нам вывело сообщение о успешной установке, приложение необходимо запустить, прописываем команду httpd.exe -k start (этой командой мы запустили наш сервер). Чтобы не запускать сервер каждый раз через командную сороку, заходим в службы выбираем Apache24 и нажимаем запустить.

### Публикация «1С:Предприятие» на web – сервере 
Перейдем непосредственно к выгрузке «1С:Предприятие» на Web – сервер. Заходим в конфигурацию информационной базы, которую хотим выгрузить на web – сервер. Выбираем вкладку Администрирование и в выпадающем меню выбираем «Публикация на веб – сервере …» Далее открывается меню для публикации, в котором надо ввести имя базы для выгрузки, выбрать сервер, на которым будет публиковаться база и папку, в которой всё это будет хранится (Для имени базы и папки для хранения, а также в пути папки не должно быть русских символов, следует использовать латинские буквы). Также при публикации необходимо выбрать HTTP сервис и корневой URL (при их наличии) для того, чтобы работали прописанные сервисы в информационной базе. После чего нажимаем на кнопку «Опубликовать». На этом всё, база опубликована на Web – сервере.

### Создание http сервиса 
Для того, чтобы мы могли передавать данные из справочника или документа в другую базу или на другой сервер, необходимо получить эти данные (данные можно получить в JSON, XML или в TXT формате), а после записать их в строку (или в файл) и отправить её. В этом удобно использовать http сервисы. Для создания http сервиса, в окне конфигурации заходим на вкладку общие, находим там HTTP-сервисы, нажимаем правую кнопку мыши и выбираем поле «Добавить».В появившемся окне вводим название нашего сервиса, синоним заполняется автоматически, комментарий (комментарий н является обязательным полем, поэтому его заполнение происходит по желанию). После чего мы добавляем нашему сервису шаблоны и методы.Сам функционал http запроса описывается именно в поле метод с соответствующим HTTP – метод (GET, POST, DELETE и т.д.).

### HTTP сервис на POST
Для того чтобы отправить данные из нашего документа мы использовали функцию «ЖурналРегистрацииPOST». 
		СтрокаJSON = Запрос.ПолучитьТелоКакСтроку();
		СтруктураJSON = ПарсимJSON(СтрокаJSON);   
		Если СтруктураJSON = неопределено Тогда 
			Ответ = Новый HTTPСервисОтвет(404); 
			Ответ.Заголовки.Вставить("Content-type","text/html; charset=utf-8"); 
			Ответ.УстановитьТелоИзСтроки("Не удалось прочитать JSON! ","UTF-8"); 
			Возврат Ответ;
		КонецЕсли;

В данной части функции мы формируем строку JSON из нашего документа и составляет его структуру, если структура неопределенна, то на сервер вернется ответ с кодом 404.

Так как у нас обращение идет не на прямую к документу, а к журналу регистраций, где отображаются все действия, совершаемые в информационной базе, нам необходимо добавить фильтр, чтобы передавались только нужные данные запрашиваемых документов или справочников. Место функции, где это реализовано представлено ниже.

Если (ЗначениеЗаполнено(Объекты) = ложь) или (ЗначениеЗаполнено(События ) = ложь)  Тогда
			Ответ = Новый HTTPСервисОтвет(404); 
			Ответ.Заголовки.Вставить("Content-type","text/html; charset=utf-8"); 
			Ответ.УстановитьТелоИзСтроки("Не заполнены фильтры ! ","UTF-8"); 
			Возврат Ответ;		
		КонецЕсли;
		Транзакция =    СтруктураJSON["Transaction"]; 
		ФильтрЖурнала = Новый Структура; 
		Журнал = Новый ТаблицаЗначений; 
		ФильтрЖурнала.Вставить("Событие", События);
		ФильтрЖурнала.Вставить("Метаданные",Объекты); 
		ДатаНачала = НачалоДня(ТекущаяДата());//НачалоДня(Дата("20220601"));
		ДатаОкончания = КонецДня(ТекущаяДата()); 
		ФильтрЖурнала.Вставить("ДатаНачала",ДатаНачала);    
		ФильтрЖурнала.Вставить("ДатаОкончания",ДатаОкончания);
		ВыгрузитьЖурналРегистрации(Журнал, ФильтрЖурнала,"Дата, ПредставлениеСобытия, Данные, Транзакция"); 
		Журнал.Свернуть("Дата, Данные, Транзакция");   
		Журнал.Сортировать("Дата Убыв, Данные, Транзакция Убыв");
		МассивОтветов = Новый Массив; 
		Для Каждого Стр Из Журнал Цикл  
			Если Стр.Транзакция = Транзакция Тогда
				Прервать;
			КонецЕсли;
			Если СтрДанные = Стр.Данные Тогда
				Продолжить;	
			КонецЕсли;

После фильтров мы передаем структуру, чтобы получить непосредственно структуру объекта, а после в сформированную строку передаем данные из нашего документа, записываем их в строку и передаем на сервер. 

СтруктураОбъекта = ПолучитьСтруктуруОбъекта(Стр.Данные);
			СтруктураОбъекта.Вставить("Транзакция", Стр.Транзакция); 
			СтруктураОбъекта.Вставить("НомерЭлНакл", TTN_ID);
			МассивОтветов.Добавить(СтруктураОбъекта);
		КонецЦикла;
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();  
		//Сериализуем данные в JSON
		ЗаписатьJSON(ЗаписьJSON,МассивОтветов);
		СтрокаДляОтвета = ЗаписьJSON.Закрыть();
		Ответ = Новый HTTPСервисОтвет(200); 
		Ответ.Заголовки.Вставить("Content-type","application/json; charset=utf-8"); 
		Ответ.УстановитьТелоИзСтроки(СтрокаДляОтвета,"UTF-8"); 
		Возврат Ответ;		
	Исключение
		Ответ = Новый HTTPСервисОтвет(200); 
		Ответ.Заголовки.Вставить("Content-type","application/json; charset=utf-8"); 
		Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки(),"UTF-8"); 
		Возврат Ответ;		
	КонецПопытки;


### HTTP сервис на GET
Помимо выгрузки данных из документа, нам необходимо еще и прочитать данные из пришедшей строки JSON и записать их в соответствующий документ или справочник. 
	//ПОЛУЧАЕМ ДАННЫЕ ИЗ ТЕЛА ЗАПРОСА
	СтрокаJSON = Запрос.ПолучитьТелоКакСтроку();
	СтруктураДок = ПарсимJSON(СтрокаJSON);    
	Если СтруктураДок = неопределено Тогда 
		Ответ = Новый HTTPСервисОтвет(404); 
		Ответ.Заголовки.Вставить("Content-type","text/html; charset=utf-8"); 
		Ответ.УстановитьТелоИзСтроки("Ошибки в структуре JSON","UTF-8"); 
		Возврат Ответ;	
	КонецЕсли;	

После того, как мы получили данные из тела запроса. Нам необходимо определить в какой документ или справочник их записать.

ИначеЕсли СтруктураДок ["ВидОбъекта"] = "Документ_КлиентыТестДокумент" Тогда 
		//ИЛИ СтруктураДок[0]["Вид"] = "КлиентыТест1" 
	Объект1C8 = "КлиентыТестДокумент";
		ИначеЕсли СтруктураДок ["ВидОбъекта"] = "Справочник_КлиентыТестСправочник" Тогда 
		//ИЛИ СтруктураДок[0]["Вид"] = "КлиентыТест1" 
	Объект1C8 = "КлиентыТестСправочник";
	КонецЕсли; 

После, согласно переданному значению объекту «Объект1C8», мы передаем в эту переменную соответствующую функцию. 

ИначеЕСли Объект1C8 = "КлиентыТестДокумент" Тогда 
			ТекстОшибки = СоздатьКлиентыТестДокумнент(СтруктураДок,Объект1C8,Данные);
		ИначеЕСли Объект1C8 = "КлиентыТестСправочник" Тогда 
			ТекстОшибки = СоздатьКлиентыТестСправочник(СтруктураДок,Объект1C8,Данные);
		КонецЕсли; 
		Если Не ПустаяСтрока(ТекстОшибки) Тогда
			ОтменитьТранзакцию();
			Ответ = Новый HTTPСервисОтвет(404);
			Ответ.Заголовки.Вставить("Content-type","text/html; charset=utf-8"); 
			Ответ.УстановитьТелоИзСтроки(ТекстОшибки,"UTF-8"); 
			Возврат Ответ;
		КонецЕсли;

Функция СоздатьКлиентыТестСправочник (СтруктураДок,Объект1С8, Данные) Экспорт 
	
	Запись =  СтруктураДок;  
	Объект1C8 = "КлиентыТестСправичник";
	ТекстЗапроса = "
	|ВЫБРАТЬ Ссылка
	|ИЗ Справочник." + Объект1C8 + " КАК ВидСправочника
	|ГДЕ
	| ВидСправочника.Код = &Код";
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Код", Запись["Код"]);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда  
		Возврат "Такая запись справочника уже существует в 1С 8 " + Выборка.Ссылка;
	КонецЕсли;

	ЗаписьСправочника = Справочники.КлиентыТестСправичник.СоздатьЭлемент();
	ЗаписьСправочника.Наименование = Запись["Наименование"];
	ЗаписьСправочника.Имя = Запись["Имя"];
	ЗаписьСправочника.Фамилия = Запись["Фамилия"];
	ЗаписьСправочника.Отчество = Запись["Отчество"];
	ЗаписьСправочника.Возраст = Число(Запись["Возраст"]);
	ЗаписьСправочника.Записать();
 
КонецФункции

Функция СоздатьКлиентыТестДокумнент (СтруктураДок,Объект1С8, Данные) Экспорт 
	
	Запись =  СтруктураДок;  
	Объект1C8 = "КлиентыТестДокумент";
	ТекстЗапроса = "
	|ВЫБРАТЬ Ссылка
	|ИЗ Документ." + Объект1C8 + " КАК ВидДокумента
	|ГДЕ
	| ВидДокумента.Номер = &Номер";
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Номер", Запись["Номер"]);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда  
		Возврат "Такой документ уже существует в 1С 8 " + Выборка.Ссылка;
	КонецЕсли;
	
	Док = Документы.КлиентыТестДокумент.СоздатьДокумент();
//	Дата = Дата(Запись["Дата"]);
	Док.Дата = Дата(Запись["Дата"]);
	Док.Номер = Запись["Номер"];
	Док.Имя = Запись["Имя"];
	Док.Записать();  
	
КонецФункции

После того, как мы перешли к нужной нам функции и в соответствии с ней выбрали нужные нам данные и передали эти значения в соответсвующие поля, возвращаемся в главную функцию и осуществляем транзакцию для записи файлов. Если транзакция произошла успешно, то на сервер возвращается ответ с кодом 200, если нет, то код ошибки 404.

ЗафиксироватьТранзакцию(); 
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();  
		//Сериализуем данные в JSON
		ЗаписатьJSON(ЗаписьJSON,Данные);
		СтрокаДляОтвета = ЗаписьJSON.Закрыть();
		Ответ = Новый HTTPСервисОтвет(200); 
		Ответ.Заголовки.Вставить("Content-type","application/json; charset=utf-8"); 
		Ответ.УстановитьТелоИзСтроки(СтрокаДляОтвета,"UTF-8"); 
		Возврат Ответ;			
	Исключение  
		ОтменитьТранзакцию();
		Ответ = Новый HTTPСервисОтвет(404);
		Ответ.Заголовки.Вставить("Content-type","text/html; charset=utf-8"); 
		Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки(),"UTF-8"); 
		Возврат Ответ;
	КонецПопытки;


Ниже представлена функция ПарсимJSON, которая отвечает за чтение строки JSON.

Функция ПарсимJSON(СтрокаJSON) Экспорт
	Попытка 
		ЧтениеJSON = Новый ЧтениеJSON();
		ЧтениеJSON.УстановитьСтроку(СтрокаJSON);	
		РаспJSON = ПрочитатьJSON(ЧтениеJSON, Истина); 
		ЧтениеJSON.Закрыть(); 
		Исключение
		РаспJSON = неопределено;
	КонецПопытки;
	Возврат РаспJSON;
КонецФункции



# Инструкция к работе с Apache Kafka
#### Apache Kafka
**Apache Kafka** — распределённый программный брокер сообщений. Написан на языках программирования Java и Scala.
Спроектирован как распределённая, горизонтально масштабируемая система, обеспечивающая наращивание пропускной способности как при росте числа и нагрузки со стороны источников, так и количества систем-подписчиков. Подписчики могут быть объединены в группы.
___
#### Для установки нужно:
Включить Hyper-V в панели управления -> Программы и компоненты -> добавить-> Диспетчер Hyper-V -> Создать виртуальную машину.
При установке сервера принимаем все требования и устанавливаем SSH (Ссылка на видео установки в источниках).
На виртуальной машине устанавливаем JRE, после чего устанавливаем сам Apache kafka
*curl -LO https://dlcdn.apache.org/kafka/3.2.1/kafka_2.13-3.2.1.tgz*
И распаковываем
*tar -xvzf /tmp/kafka_2.13-3.2.1.tgz --strip 1*

#### Запуск Kafka и zookeeper

Создание сервисов:\
sudo nano /etc/systemd/system/kafka.service  
Вставить:  
[Unit]  
Requires=zookeeper.service  
After=zookeeper.service  
[Service]  
Type=simple  
User=kafka  
ExecStart=/bin/sh -c '/home/kafka/kafka/bin/kafka-server-start.sh /home/kafka/kafka/config/server.properties > /home/kafka/kafka/kafka.log 2>&1'  
ExecStop=/home/kafka/kafka/bin/kafka-server-stop.sh Restart=on-abnormal [Install]  
WantedBy=multi-user.target  

sudo nano /etc/systemd/system/zookeeper.service  

[Unit]   
Requires=network.target remote-fs.target   
After=network.target remote-fs.target   
[Service] Type=simple   
User=kafka   
ExecStart=/home/kafka/kafka/bin/zookeeper-server-start.sh /home/kafka/kafka/config/zookeeper.properties   
ExecStop=/home/kafka/kafka/bin/zookeeper-server-stop.sh Restart=on-abnormal [Install]   
WantedBy=multi-user.target  


**Для запуска используем (при наличии сервисов)**  
*sudo systemctl start/stop/status kafka/zookeeper(start/stop/status)*  
**Или запускаем напрямую через скрипты**  
*~kafka/bin/zookeeper-server-start.sh ~kafka/config/zookeeper.properties* (Запуск zookeeper)  
*~/kafka/bin/kafka-server-start.sh ~/kafka/config/server.properties* (Запуск kafka)  

**Запуск скриптов для остановки**  
*/home/kafka/kafka/bin/kafka-server-stop.sh*  
*/home/kafka/kafka/bin/zookeeper-server-stop.sh*  

**Для обращения к Брокерам используется:**  
*--bootstrap-server localhost:9092 --zookeeper localhost:2181*  
#### Необходимые команды для работы с Apache Kafka  
**Лист топиков:** *~/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list*  

**Создать топик:** *~/kafka/bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic Название_топика*

**Отправление(с созданием топика):** *Что_отправить | ~/kafka/bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic Название_топика*

**Удаление топика:** *~/kafka/bin/kafka-topics.sh --delete --topic Название_топика --bootstrap-server localhost:9092*

**Отправка сообщений:** *~/kafka/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic Навзание_топика*

**Отправка сообщений с ключом:** *~/kafka/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic Название_топика --property "key.separator=-" --property "parse.key=true"*

**Принятие сообщений:** *~/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic Название_топика --from-beginning*

**Принятие сообщений с ключом:** *~/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic Название_топика --from-beginning --property "key.separator= - " --property "print.key=true"*
(key.separator – разделитель ключ-значение)


**Узнать время хранения сообщений:** *grep -i 'log.retention.[hms]. * \=' config/server.properties*

**Полные настройки топика:** *~/kafka/bin/kafka-configs.sh --describe --all --bootstrap-server=localhost:9092 --topic Название_потика*

**Таймер для отдельного топика:** *~/kafka/bin/kafka-configs.sh --alter --add-config retention.ms = 300000 --bootstrap-server localhost:9092 --topic Название_топика*

**Также присутствуют:** *log.retention.hours,log.retention.minutes и log.retention.ms*

**Подключение к ZooKeeper:** *~/kafka/bin/zookeeper-shell.sh localhost:2181*

**Узнать лист топиков(после подключения ZooKeeper):** *ls /brokers/ids*

**Информация о топиках:** *~/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe*

**Узнать занятые порты:** *netstat -pnltu*
**Завершить процесс:** *kill -9 pid*

**Список групп:** *~/kafka/bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list*

**Удалить группу пользователей:** *~/kafka/bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --delete --group Название_группы*




**Открытие kafka для подключения:**
*sudo iptables -A INPUT -p tcp --dport 9092 -j ACCEPT*
заменить *advertised.listeners* в *server.properties* на *advertised.listeners=PLAINTEXT://192.168.205.106:9092*




#### Источники для работы с Apache kafka

https://ruvds.com/ru/helpcenter/kak-ustanovit-apache-kafka-na-ubuntu-20-04/ Установка Apache kafka на сервер  
https://www.youtube.com/watch?v=fOh98R9usck&t=702s Видео про несколько серверов  
https://www.tutorialspoint.com/apache_kafka/apache_kafka_basic_operations.htm Создание нескольких брокеров  
https://vk.com/doc565756056_591392461?hash=bNCJxh3bbCLTfpl0RUzs96KlkjsXu2tuw6KyJN11FUw Apache kafka потоковая обработка и анализ данных  
https://russianblogs.com/article/8418667672/ Параметры для Kafka из консоли  
https://www.youtube.com/watch?v=EAphCykdjA0 Установка linux ubuntu server  

